---
title: "Informe Amparos"
author: "CDD"
output: 
  html_document:
     toc: yes
     code_folding: hide
     toc_float: yes
     df_print: paged
     theme: united
     code_download: true
     includes:
       before_body: logo.html
     warning: FALSE
date: "`r format(Sys.time(), '%d-%m-%Y')`"

---


```{css, echo=FALSE}
.tocify .tocify-item.active,
.tocify .tocify-item.tocify-active { 
  background-color: #0046b3 !important;
  color: white !important;
}
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE)
```


```{r, include=FALSE}

# Levantamos las liberias
library(tidyverse)
library(DBI)
library(odbc)
library(knitr)
library(kableExtra)
library(tictoc)
library(dplyr)


# Sacamos la notacion cientifica
options(scipen = 999)

# Set encoding
invisible(Sys.setlocale("LC_CTYPE", "es_ES.UTF-8"))

# Diferentes GIFS 
# https://miro.medium.com/v2/resize:fit:1400/0*Xe3YnRNqb7AuIUdu.gif
# https://antonio-richaud.com/blog/imagenes/archivo/36-kmeans-vs-gmm/kmeans.gif

```


```{r, include=FALSE}

###############################################################################################
# Levantamos la base de legales                                                               #
###############################################################################################


conn <- dbConnect(odbc::odbc(), driver = "sql server", 
                  server = "dwdatamart.osde.ar", database = "DB_CIENCIADEDATOS", 
                  trusted_connection = "yes")



amparos <- dbGetQuery(conn = conn, "SELECT * FROM [DB_CIENCIADEDATOS].[dbo].[CDD_SOCIOS_BASE_LEGALES]")

amparos_mac <- amparos %>% 
  filter(PRODUCTO_PRINCIPAL == "Medicamentos de Alta Complejidad- MAC")

sum(is.na(amparos_mac$DNUM_IC))

###############################################################################################
# Sacamos los casos que no tenemos IC                                                         #
###############################################################################################

amparos_mac_sin_ic <- amparos_mac %>% 
  filter(is.na(DNUM_IC))

amparos_mac_con_ic <- amparos_mac %>% 
  filter(!is.na(DNUM_IC))

# ctrl 

nrow(amparos_mac)-nrow(amparos_mac_con_ic)-nrow(amparos_mac_sin_ic)



###############################################################################################
# Levantamos los consumos                                                                     #
###############################################################################################


ic_buscar <- paste0("'",amparos_mac_con_ic$DNUM_IC,"'", collapse = ", ")

# CONSUMOS DESDE ABRIL 2023 A SEPTIEMBRE 2025 ACTUALIZADOS

consumos_medicamentos_ic_amparos <- dbGetQuery(conn = conn, paste("SELECT B.DNUM_IC
      ,[DID_AGRUPAMIENTO]
      ,[DNUM_ANOMES_PRESTACION]
      ,[DNUM_FILIAL_CONSUMO]
      ,[DNUM_FILIAL_SERVICIO]
      ,[DID_PLAN]
      ,A.[DID_NOMENCLADOR]
      ,D.DDES_CORTA_PRACTICA
      ,[DID_ENTPRESTADORA_CONT]
      ,[DID_ENTPRESTADORA_EFECTOR]
      ,[NUM_CANTIDAD]
      ,[NUM_VALOR_PAGADO_HISTORICO]
      ,[NUM_VALOR_ACTUALIZADO]
      ,[DID_CLASECOSTO]
      ,[DID_TIPOPRESTACION]
      ,[DID_ORIGENGASTO]
      ,[NUM_LOTE_CONTRATACION]
      ,B.[DID_SOCIO]
      ,[DID_TIPODEUDOR]
      ,[DID_MEDICAMENTO]
      ,[DID_TIPO_FACTURACION]
      ,[DID_INSTPRESTACION]
      ,[ORIGEN]
      ,A.[DID_GRUPO_PRESUPUESTO]
      ,[DID_DISCAP_NOVAL]
      ,[DID_EDAD]
      ,[DID_MOSTRADOR]
      ,[DID_ENTPRESTADORA_PRESCRIPTOR]
      ,[DID_FECHA_PRESTACION]
      ,[DID_COBERTURA]
      ,[CONTEXTO]
      ,[DID_PMI]
  FROM [DBPresupuestos].[dbo].[DWCONS_CONSUMOS_SITUACION_ACTUAL_202509] A
  LEFT JOIN DWDATAMART.dbo.DSOCIO B
  ON A.DID_SOCIO = B.DID_SOCIO
  LEFT JOIN DWDATAMART.dbo.DGRUPO_PRESUPUESTO C
  ON A.DID_GRUPO_PRESUPUESTO = C.DID_GRUPO_PRESUPUESTO
  LEFT JOIN DWDATAMART.dbo.DNOMENCLADOR D 
  ON A.DID_NOMENCLADOR = D.DID_NOMENCLADOR
  WHERE B.DNUM_IC in (" ,ic_buscar,")
  AND C.GRUPO = '16 - MEDICAMENTOS'"))



```

<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Objetivo </b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>

El presente trabajo tiene como objetivo analizar el comportamiento de los socios que poseen amparos, focalizándonos en aquellos cuyo producto principal corresponde a **`r unique(amparos_mac$PRODUCTO_PRINCIPAL)`**. En una primera instancia se realizará un análisis descriptivo de esta población, con el propósito de comprender su composición y características principales. Posteriormente, se examinarán los patrones de consumo observados durante el período comprendido entre **`r min(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION)`** y **`r max(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION)`**, a fin de identificar los medicamentos de alto consumo.


<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Fuente de datos</b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>



La base de datos utilizada en este análisis fueron del sistema **JXNET** de legales (Amparos) y los consumos actualizados a valores de septiembre 2025 (**SITUACION_ACTUAL_202509**- DATAMART).

<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Descriptivo</b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>



Los amparos con producto **`r unique(amparos_mac$PRODUCTO_PRINCIPAL)`** representan el **`r paste0(round(nrow(amparos_mac)/nrow(amparos),4)*100,"%")`** del total.


```{r}

cuadro1 <- amparos %>% 
  mutate(PRODUCTO_PRINCIPAL= case_when(PRODUCTO_PRINCIPAL=="Medicamentos de Alta Complejidad- MAC"~
                                       "Medicamentos de Alta Complejidad- MAC",
                                       TRUE~"Otros")) %>% 
  group_by(PRODUCTO_PRINCIPAL) %>% 
  summarise(Cantidad_Casos = n())

# Tabla
kable(cuadro1, caption = "Casos por Producto")

```

<br>


```{r,eval=FALSE}

cuadro2 <- amparos_mac %>% 
   rename("CARTERA_ACTIVA"="CARTERA_ACTIVA_SN") %>% 
  group_by(CARTERA_ACTIVA) %>% 
  summarise(CANTIDAD_CASOS = n()) %>% 
  arrange(CANTIDAD_CASOS) %>% 
  arrange(desc(CANTIDAD_CASOS))

# Tabla
kable(cuadro2, caption = "Casos por Producto")

```

<br>

#### Socios con consumos en el período analizado

```{r,eval=FALSE}

cuadro3 <-  consumos_medicamentos_ic_amparos %>% 
  mutate(CONSUMOS="SI") %>% 
  group_by(CONSUMOS) %>% 
  summarise(CANTIDAD_CASOS = n_distinct(DNUM_IC)) %>% 
  arrange(CANTIDAD_CASOS) %>% 
  arrange(desc(CANTIDAD_CASOS)) %>% 
  rbind(data.frame(CONSUMOS="NO",CANTIDAD_CASOS=nrow(amparos_mac)-n_distinct(consumos_medicamentos_ic_amparos$DNUM_IC)))

# Tabla
kable(cuadro3, caption = "Casos por Producto")

```



```{r}

consumos_medicamentos_ic_amparos$DDES_CORTA_PRACTICA <- trimws(consumos_medicamentos_ic_amparos$DDES_CORTA_PRACTICA)

agrup_medicamento <- consumos_medicamentos_ic_amparos %>% 
  filter(DDES_CORTA_PRACTICA != "MEDICAMENTOS AMBULATORIOS") %>% 
  group_by(DDES_CORTA_PRACTICA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO, na.rm = TRUE)/1000000,
            CANTIDAD_DE_SOCIOS=n_distinct(DNUM_IC),
            CANTIDAD_MEDICAMENTOS = sum(NUM_CANTIDAD)) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  as.data.frame()



agrup_medicamento$decil <- cut(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                breaks = quantile(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                                  probs = seq(0, 1, 0.1), na.rm = TRUE),
                include.lowest = TRUE,
                labels = FALSE)

#Agrupar por decil y calcular cantidad y promedio
# resumen <- aggregate(NUM_VALOR_ACTUALIZADO_EN_MILL ~ decil, data = agrup_medicamento, 
#                      FUN = function(x) c(cantidad = length(x), promedio = mean(x)))

# Convertir a data.frame
# resumen_df <- data.frame(
#   decil = resumen$decil,
#   cantidad = resumen$NUM_VALOR_ACTUALIZADO_EN_MILL[, "cantidad"],
#   promedio = resumen$NUM_VALOR_ACTUALIZADO_EN_MILL[, "promedio"]
# )

resumen_df <- agrup_medicamento %>% 
  group_by(decil) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL=sum(NUM_VALOR_ACTUALIZADO_EN_MILL, na.rm = TRUE),
            #promedio = mean(NUM_VALOR_ACTUALIZADO_EN_MILL,na.rm=TRUE),
            cantidad_socios= sum(CANTIDAD_DE_SOCIOS),
            CANTIDAD_MEDICAMENTOS=sum(CANTIDAD_MEDICAMENTOS)) %>% 
  mutate(promedio_por_socio=NUM_VALOR_ACTUALIZADO_EN_MILL/cantidad_socios)



```


El siguiente gráfico nos indica la cantidad de socios que consumieron medicamentos en un decil determinado. (El decil fue calculado según el importe agrupado por medicamento). Podemos obervar que el decil con mayor socios es el 7 y un poco mas atras el 5, 8 y 10.

<br>

```{r}
resumen_df %>% 
  ggplot(aes(x=factor(decil),y=cantidad_socios))+
  geom_col(fill = "#0047AB")+
  geom_text(aes(label = round(cantidad_socios, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Cantidad de socios por Decil",
       x = "Decil",
       y = "Cantidad") +
  theme_minimal()
```

<br>

De la misma forma se gráfico el importe promedio por socio (en millones de $). Se observa que el mayor promedio se encuentra en el decil 10 y mas atras el decil 9. Esto lo que nos esta diciendo es que en el decil 10 pocos socios consumen muchos de esos medicamentos.

<br>

```{r,eval=FALSE}
resumen_df %>% 
  ggplot(aes(x=factor(decil),y=promedio))+
  geom_col()+
  geom_text(aes(label = round(promedio, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Promedio por decil en Millones de $",
       x = "Decil",
       y = "Promedio") +
  theme_minimal()



```

<br>

```{r}
resumen_df %>% 
  ggplot(aes(x=factor(decil),y=promedio_por_socio))+
  geom_col(fill = "#0047AB")+
  geom_text(aes(label = round(promedio_por_socio, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Promedio por decil-socio en Millones de $",
       x = "Decil",
       y = "Promedio") +
  theme_minimal()



```
<br>

#### ¿Cuales son esos medicamentos?

Para reponder nos vamos a enfocar en los deciles 9 y 10,

```{r}

cuadro4 <-  agrup_medicamento %>%
  filter(decil >=9) %>% 
  group_by(DDES_CORTA_PRACTICA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO_EN_MILL),
            CANTIDAD_DE_SOCIOS=sum(CANTIDAD_DE_SOCIOS,na.rm = TRUE)) %>% 
  mutate(PROPORCION = round(NUM_VALOR_ACTUALIZADO_EN_MILL/sum(NUM_VALOR_ACTUALIZADO_EN_MILL),4)*100) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  top_n(10)
  

# Tabla
kable(cuadro4, caption = "Top 10 Medicamentos")




```




```{r, eval=FALSE}

sum(agrup_medicamento$CANTIDAD_DE_SOCIOS[agrup_medicamento$decil>=9],na.rm = TRUE)

```



```{r, eval=FALSE}
###############################################################################################
# Graficamos el decil 9 y 10                                                                  #
###############################################################################################


agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_boxplot()+
  theme_bw()

agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```

```{r, eval=FALSE}

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC,DID_NOMENCLADOR,DDES_CORTA_PRACTICA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```







```{r,eval=FALSE}
agrup_socio <- consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000,
            CANTIDAD_DE_SOCIOS=n_distinct(DNUM_IC)) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL))



agrup_medicamento$decil <- cut(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                breaks = quantile(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                                  probs = seq(0, 1, 0.1), na.rm = TRUE),
                include.lowest = TRUE,
                labels = FALSE)

#Agrupar por decil y calcular cantidad y promedio
resumen <- aggregate(NUM_VALOR_ACTUALIZADO_EN_MILL ~ decil, data = agrup_medicamento, 
                     FUN = function(x) c(cantidad = length(x), promedio = mean(x)))

# Convertir a data.frame
resumen_df <- data.frame(
  decil = resumen$decil,
  cantidad = resumen$NUM_VALOR_ACTUALIZADO_EN_MILL[, "cantidad"],
  promedio = resumen$NUM_VALOR_ACTUALIZADO_EN_MILL[, "promedio"]
)


```

```{r, eval=FALSE}
resumen_df %>% 
  ggplot(aes(x=factor(decil),y=cantidad))+
  geom_col()+
  geom_text(aes(label = round(cantidad, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Cantidad de Medicamentos por Decil",
       x = "Decil",
       y = "Cantidad") +
  theme_minimal()

resumen_df %>% 
  ggplot(aes(x=factor(decil),y=promedio))+
  geom_col()+
  geom_text(aes(label = round(promedio, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Promedio por decil en Millones de $",
       x = "Decil",
       y = "Promedio") +
  theme_minimal()



```



```{r,eval=FALSE}
###############################################################################################
# Graficamos el decil 9 y 10                                                                  #
###############################################################################################


agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_boxplot()+
  theme_bw()

agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```

```{r,eval=FALSE}

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC,DID_NOMENCLADOR,DDES_CORTA_PRACTICA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```

