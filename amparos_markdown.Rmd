---
title: "Informe Amparos"
author: "CDD"
output: 
  html_document:
     toc: yes
     code_folding: hide
     toc_float: yes
     df_print: paged
     theme: united
     code_download: true
     includes:
       before_body: logo.html
     warning: FALSE
date: "`r format(Sys.time(), '%d-%m-%Y')`"

---


```{css, echo=FALSE}
.tocify .tocify-item.active,
.tocify .tocify-item.tocify-active { 
  background-color: #0046b3 !important;
  color: white !important;
}
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE)
```


```{r, include=FALSE}

# Levantamos las liberias
library(tidyverse)
library(DBI)
library(odbc)
library(knitr)
library(kableExtra)
library(tictoc)
library(dplyr)
library(grid)
library(lubridate)
source("Z:/Gcia Presupuesto/DATA MINING/R/functions/dates.R")

# Sacamos la notacion cientifica
options(scipen = 999)

# Set encoding
invisible(Sys.setlocale("LC_CTYPE", "es_ES.UTF-8"))

# Diferentes GIFS 
# https://miro.medium.com/v2/resize:fit:1400/0*Xe3YnRNqb7AuIUdu.gif
# https://antonio-richaud.com/blog/imagenes/archivo/36-kmeans-vs-gmm/kmeans.gif

```


```{r, include=FALSE}

###############################################################################################
# Levantamos la base de legales + consumos + precios monodroga                                #
###############################################################################################

load("Z:/Gcia Presupuesto/DATA MINING/desarrollo/alejandro/laburo/amparos/amparos_consumos.RData")

amparos_mac <- amparos %>%
  filter(PRODUCTO_PRINCIPAL == "Medicamentos de Alta Complejidad- MAC")

load("Z:/Gcia Presupuesto/00_COSTOS/COSTOS/MEDICAMENTOS/PRECIOS_MINIMOS_MAC/PRECIOS_MINIMOS_MAC.RData")

#sum(is.na(amparos_mac$DNUM_IC))

###############################################################################################
# Sacamos los casos que no tenemos IC                                                         #
###############################################################################################

amparos_mac_sin_ic <- amparos_mac %>%
  filter(is.na(DNUM_IC))

amparos_mac_con_ic <- amparos_mac %>%
  filter(!is.na(DNUM_IC))

# ctrl

nrow(amparos_mac)-nrow(amparos_mac_con_ic)-nrow(amparos_mac_sin_ic)


```

```{r include=FALSE}

consumos_medicamentos_ic_amparos$DDES_MOTIVO_BAJA <- trimws(consumos_medicamentos_ic_amparos$DDES_MOTIVO_BAJA)

motivo_baja_fallec <- consumos_medicamentos_ic_amparos %>%
  filter(grepl("allec", DDES_MOTIVO_BAJA, ignore.case = TRUE)) %>% 
  select(DNUM_IC, DDES_MOTIVO_BAJA) %>% distinct()

motivo_baja_fallec$DDES_MOTIVO_BAJA <- "Fallecimiento"

fecha_min_consumo <- min(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION)

amparos <- amparos %>% 
  mutate(PERIODO_CONSUMO = case_when(CARTERA_ACTIVA_SN=="S"~ "Cartera Activa",
                                     TRUE ~ "Cartera No Activa"))  


amparos$DNUM_IC <- as.character(amparos$DNUM_IC)

amparos_mac <- amparos %>% 
  filter(PRODUCTO_PRINCIPAL == "Medicamentos de Alta Complejidad- MAC") %>% 
  left_join(motivo_baja_fallec)

amparos_mac$DDES_MOTIVO_BAJA[is.na(amparos_mac$DDES_MOTIVO_BAJA)] <- "Cartera"


```


<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Objetivo </b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>

El presente trabajo tiene como objetivo analizar el comportamiento de los socios que poseen amparos, focalizándonos en aquellos cuyo producto principal corresponde a **`r unique(amparos_mac$PRODUCTO_PRINCIPAL)`**. En una primera instancia se realizará un análisis descriptivo de esta población, con el propósito de comprender su composición y características principales. Posteriormente, se examinarán los patrones de consumo observados durante el período comprendido entre **`r num2yearmon(min(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION))`** y **`r num2yearmon(max(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION))`**, a fin de identificar los medicamentos de alto consumo.


<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Fuente de datos</b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>



La base de datos utilizada en este análisis fueron del sistema **JXNET** de legales (Amparos - Con fecha de inicio desde **`r format(num2date(min(amparos_mac$FECHA_INICIO)), "%b. %Y")`** a **`r format(num2date(max(amparos_mac$FECHA_INICIO)), "%b. %Y")`**  ) y los consumos actualizados a valores de septiembre 2025 (**SITUACION_ACTUAL_202509**- DATAMART). 

<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Descriptivo</b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>



Los amparos con producto **`r unique(amparos_mac$PRODUCTO_PRINCIPAL)`** representan el **`r paste0(round(nrow(amparos_mac)/nrow(amparos),4)*100,"%")`** del total.

Comenzamos con un universo de 580 socios MAC. De estos, 58 socios fallecieron, por lo que fueron excluidos del estudio.

De los 522 socios restantes nos enfocamos en los 476 socios que se encuentran en la cartera activa. Los 46 socios con cartera no activa fueron excluidos por no cumplir con los criterios de inclusión del estudio.

<br>

```{r}
motivo_baja <- amparos_mac %>% 
  group_by(DDES_MOTIVO_BAJA) %>% 
  summarise(conteo=n())

consumos <- amparos_mac %>% 
  filter(DDES_MOTIVO_BAJA=="Cartera") %>% 
  group_by(PERIODO_CONSUMO) %>% 
  summarise(conteo=n())


datos <- data.frame(
  #paso = c("Socios MAC", unique(amparos_mac$DDES_MOTIVO_BAJA), unique(amparos_mac$PERIODO_CONSUMO)),
  paso = c("Socios MAC", unique(amparos_mac$DDES_MOTIVO_BAJA),
           "Cartera Activa", "Cartera No Activaa"),
  n = c(nrow(amparos_mac), motivo_baja$conteo, consumos$conteo),
  x = c(1, 0, 2, -0.75, 0.75),
  y = c(2, 1, 1, 0, 0),
  color = c("#0057B8", "#0057B8", "#0057B8", "#E67E22", "#0057B8")
)


# Gráfico con bloques y conexiones
ggplot(datos) +
  # Bloques azules
    geom_rect(aes(xmin = x - 0.5, xmax = x + 0.5, ymin = y - 0.2, ymax = y + 0.2,fill = color),
              color = "black") +
  
  # Texto dentro de los bloques
  geom_text(aes(x = x, y = y,
                label = paste0(paso, "\n(n = ", format(n, big.mark = "."), ")")),
            color = "white", size = 4, lineheight = 1.1) +
  
  # Flechas entre niveles
  geom_segment(aes(x = 1, xend = 0, y = 1.8, yend = 1.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  geom_segment(aes(x = 1, xend = 2, y = 1.8, yend = 1.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  
  # Flechas desde "Activos" hacia los dos subniveles
  geom_segment(aes(x = 0, xend = -0.5, y = 0.8, yend = 0.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  geom_segment(aes(x = 0, xend = 0.5, y = 0.8, yend = 0.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  
  # Tema general
  scale_fill_identity() +
  theme_void() +
  coord_fixed(ratio = 1)

```

<br>

#### Socios con consumos en el período analizado

<br>

```{r}

consumos_medicamentos_ic_amparos$DDES_CORTA_PRACTICA <- trimws(consumos_medicamentos_ic_amparos$DDES_CORTA_PRACTICA)

amparos_mac_analisis <- amparos_mac %>%
                filter(PERIODO_CONSUMO=="Cartera Activa"&DDES_MOTIVO_BAJA!="Fallecimiento")


meses_promedio_consumo_medicamento <- consumos_medicamentos_ic_amparos %>%
  filter(!DDES_CORTA_PRACTICA %in% c("MEDICAMENTOS AMBULATORIOS","MEDICAMENTOS GTOS DE DISPENSA")) %>% 
  inner_join(amparos_mac_analisis %>% # nos quedamos solo con los mac_analisis 
              select(DNUM_IC,PERIODO_CONSUMO) %>%
              distinct()) %>% 
  #group_by(DNUM_IC,DDES_CORTA_PRACTICA, DDES_MEDICAMENTO, DDES_MONODROGA, PERIODO_CONSUMO) %>%
  #group_by(DNUM_IC, DDES_CORTA_PRACTICA) %>% 
  group_by(DNUM_IC,DDES_MONODROGA) %>% #quiero saber cuantos meses consumio cada socio la monodroga
  summarise(conteo_meses_consumo = n_distinct(DNUM_ANOMES_PRESTACION)) %>% 
  #group_by(DDES_CORTA_PRACTICA,DDES_MEDICAMENTO, DDES_MONODROGA, PERIODO_CONSUMO) %>% 
  group_by(DDES_MONODROGA) %>% 
  summarise(meses_promedio=round(mean(conteo_meses_consumo),2))

amparos$DNUM_IC <- as.character(amparos$DNUM_IC)

amparos_mac_analisis <- amparos_mac %>%
                filter(PERIODO_CONSUMO=="Cartera Activa"&DDES_MOTIVO_BAJA!="Fallecimiento")

amparos_mac_analisis$DNUM_IC <- as.character(amparos_mac_analisis$DNUM_IC)

agrup_medicamento <- consumos_medicamentos_ic_amparos %>% 
  filter(!DDES_CORTA_PRACTICA %in% c("MEDICAMENTOS AMBULATORIOS","MEDICAMENTOS GTOS DE DISPENSA")) %>% 
  inner_join(amparos_mac_analisis %>% # nos quedamos solo con los mac_analisis 
              select(DNUM_IC,PERIODO_CONSUMO) %>%
              distinct()) %>% 
  left_join(PRECIOS_MINIMOS %>% group_by(DDES_MONODROGA) %>%   summarise(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO=max(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO))) %>% 
  group_by(DDES_MONODROGA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO, na.rm = TRUE)/1000000,
            NUM_VALOR_ACTUALIZADO_EN_MILL2 = sum(NUM_VALOR_ACTUALIZADO, na.rm = TRUE),
            CANTIDAD_DE_SOCIOS=n_distinct(DNUM_IC),
            CANTIDAD_MEDICAMENTOS = sum(NUM_CANTIDAD),
            MIN_IMPORTE_FINAL_CON_NOTA_CREDITO=mean(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO)
            ) %>%
  mutate(PRECIO_MONODROGA = NUM_VALOR_ACTUALIZADO_EN_MILL2/CANTIDAD_MEDICAMENTOS) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  as.data.frame() %>% 
  left_join(meses_promedio_consumo_medicamento)



agrup_medicamento$decil <- cut(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                breaks = quantile(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                                  probs = seq(0, 1, 0.1), na.rm = TRUE),
                include.lowest = TRUE,
                labels = FALSE)

resumen_df <- agrup_medicamento %>% 
  group_by(decil) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL=sum(NUM_VALOR_ACTUALIZADO_EN_MILL, na.rm = TRUE),
            NUM_VALOR_ACTUALIZADO_EN_MILL2=sum(NUM_VALOR_ACTUALIZADO_EN_MILL2, na.rm = TRUE),
            #promedio = mean(NUM_VALOR_ACTUALIZADO_EN_MILL,na.rm=TRUE),
            cantidad_socios= sum(CANTIDAD_DE_SOCIOS),
            CANTIDAD_MEDICAMENTOS=sum(CANTIDAD_MEDICAMENTOS),
            meses_promedio=mean(meses_promedio)) #%>% 
  #mutate(promedio_por_socio=NUM_VALOR_ACTUALIZADO_EN_MILL/cantidad_socios,
         #promedio_mensual_socio=NUM_VALOR_ACTUALIZADO_EN_MILL2/meses_promedio)



```

```{r}
agrup_medicamento2 <- consumos_medicamentos_ic_amparos %>% 
  filter(!DDES_CORTA_PRACTICA %in% c("MEDICAMENTOS AMBULATORIOS","MEDICAMENTOS GTOS DE DISPENSA")) %>% 
  inner_join(amparos_mac_analisis %>% # nos quedamos solo con los mac_analisis 
              select(DNUM_IC,PERIODO_CONSUMO) %>%
              distinct()) %>% 
   mutate(DCOD_PLAN = case_when(DCOD_PLAN %in%c("2 410", "2 510","2 450")~"410/450/510",
                                DCOD_PLAN %in% c("1 015","2 025")~"OTROS",
                                TRUE ~ DCOD_PLAN),
          EDAD=round(DID_EDAD/12,0)) %>%
  mutate(EDAD_AGRUP=cut(EDAD, 
                  breaks = seq(min(EDAD), max(EDAD), by = 5), 
                  right = FALSE, 
                  include.lowest = TRUE)) %>% 
  filter(!DDES_CORTA_PRACTICA %in% c("MEDICAMENTOS AMBULATORIOS","MEDICAMENTOS GTOS DE DISPENSA")) %>% 
  inner_join(amparos_mac_analisis %>% # nos quedamos solo con los mac_analisis 
               select(DNUM_IC,PERIODO_CONSUMO) %>%
               distinct()) %>% 
  
  #group_by(EDAD_AGRUP,DCOD_SEXO,DCOD_PLAN,DDES_MONODROGA) %>% 
  #group_by(EDAD_AGRUP,DCOD_SEXO,DCOD_PLAN) %>% 
  group_by(DCOD_SEXO,DCOD_PLAN) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL2 = sum(NUM_VALOR_ACTUALIZADO, na.rm = TRUE)/1000000,
            CANTIDAD_DE_SOCIOS=n_distinct(DNUM_IC),
            CANTIDAD_MEDICAMENTOS = sum(NUM_CANTIDAD)) %>%
  mutate(PRECIO_MONODROGA = (NUM_VALOR_ACTUALIZADO_EN_MILL2/CANTIDAD_MEDICAMENTOS)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL2))

```

El gráfico muestra la distribución del importe total en millones de pesos según el sexo y el plan de cobertura.

En términos generales, se observa que las diferencias entre sexos no son marcadas, aunque existen variaciones dentro de cada plan:

En el plan 210, las mujeres (F) concentran un importe total ligeramente superior al de los hombres (M).

En el plan 310, ambos sexos presentan montos similares, siendo apenas mayor el total en mujeres.

En el plan 410/450/510, los hombres muestran un gasto total más elevado en comparación con las mujeres.

En la categoría “Otros” (Plan 015 - Plan 025), se observa una marcada diferencia entre los sexos.

En síntesis, los resultados sugieren que el comportamiento del gasto no presenta grandes diferencias por sexo, aunque sí se aprecian variaciones relevantes según el plan, con los planes 210 y 310 concentrando los mayores importes totales.

<br>

```{r}
# Gráfico de barras
ggplot(agrup_medicamento2, aes(x = DCOD_SEXO, y = NUM_VALOR_ACTUALIZADO_EN_MILL2, fill = DCOD_SEXO)) +
  geom_bar(stat = "identity",, position = position_dodge(width = 0.9)) +
  geom_text(aes(label = round(NUM_VALOR_ACTUALIZADO_EN_MILL2, 2)),
            position = position_stack(vjust = 0.5), 
            #vjust = -0.5,              # posición vertical
            size = 4,                  # tamaño del texto
            color = "black",           # color del texto
            fontface = "bold") +       # negrita
  labs(
    title = "Importe total en Mill. $ por sexo y plan",
    x = "Sexo",
    y = "Importe total"
  ) +
  facet_wrap(~DCOD_PLAN, scale="free")+
  #scale_fill_manual(values = c("#0057B8", "#87CEEB")) +  # colores azul/celeste
  theme_minimal()


```






El siguiente gráfico nos indica la cantidad de socios que consumieron medicamentos en un decil determinado. (El decil fue calculado según el importe agrupado por monodroga). Podemos obervar que el decil con mayor socios es el 10 y un poco mas atras el 4, 5 y 9.

<br>

```{r}
resumen_df %>% 
  ggplot(aes(x=factor(decil),y=cantidad_socios))+
  geom_col(fill = "#0047AB")+
  geom_text(aes(label = round(cantidad_socios, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Cantidad de socios por Decil",
       x = "Decil",
       y = "Cantidad") +
  theme_minimal()
```

<br>

De la misma forma se gráfica el importe total por decil (en millones de $). El mayor importe se encuentra en el decil 10 y mas atras el decil 9. 

<br>

```{r}

# resumen_df2 <- agrup_medicamento %>% 
#   mutate(consumo_promedio_mensual_por_socio = (NUM_VALOR_ACTUALIZADO_EN_MILL2/meses_promedio)/1000000)

resumen_df %>% 
  ggplot(aes(x=factor(decil),y=NUM_VALOR_ACTUALIZADO_EN_MILL))+
  geom_col(fill = "#1E90FF")+
  #geom_col()+
  geom_text(aes(label = round(NUM_VALOR_ACTUALIZADO_EN_MILL, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Valor por decil en Millones de $",
       x = "Decil",
       y = "Promedio") +
  theme_minimal()



```

<br>

En el gráfico de cajas observamos la distribución del precio de la monodroga en el percentil 10. La mayoría de los valores se concentran entre aproximadamente 5 y 20 millones, lo que indica que la dispersión principal está en ese rango. La línea central representa la mediana, que está cerca del centro del rango intercuartílico, sugiriendo una distribución relativamente simétrica en ese segmento. Sin embargo, se identifican dos valores atípicos significativos alrededor de 55 y 60 millones, lo que indica que existen precios considerablemente más altos que el resto. Como dato adicional el tamaño de los puntos nos dice sobre la cantidad de socios que consumen una misma monodroga.

<br>

```{r}
bpBd <-  agrup_medicamento %>%
  filter(decil ==10) %>% 
  group_by(DDES_MONODROGA) %>% 
  summarise(VALOR_ACTUALIZADO = round(sum(NUM_VALOR_ACTUALIZADO_EN_MILL2)/1000000,2),
            CANTIDAD_DE_SOCIOS=sum(CANTIDAD_DE_SOCIOS,na.rm = TRUE),
            MESES_PROMEDIO_CONSUMO = round(sum(meses_promedio),0),
            PRECIO_MONODROGA = round(sum(PRECIO_MONODROGA)/1000000,2))

bpBd %>% 
  ggplot(aes(x="",y=PRECIO_MONODROGA))+
  geom_boxplot()+
  geom_jitter(aes(y = PRECIO_MONODROGA, size = CANTIDAD_DE_SOCIOS),
              width = 0.2, alpha = 0.6, color = "blue") +
  coord_flip()+
  labs(title = "Boxplot Precio Monodroga en Mill. $ Decil 10",
       x = NULL) +
  theme_minimal()

# bpBd %>% 
#   filter(PRECIO_MONODROGA<=40) %>% 
#   ggplot(aes(x="",y=PRECIO_MONODROGA))+
#   geom_boxplot()+
#   geom_jitter(aes(y = PRECIO_MONODROGA, size = CANTIDAD_DE_SOCIOS),
#               width = 0.2, alpha = 0.6, color = "blue") +
#   coord_flip()+
#   labs(title = "Boxplot Precio Monodroga Percentil 10",
#        x = NULL) +
#   theme_minimal()
  


```

<br>

#### ¿Cuales son esos medicamentos?

En el gráfico de cajas observamos un punto que se destaca entre los demas, en el siguiente cuadro vemos que son casos cuyo monodroga no existe (NA - 302 casos).

```{r}

### PROPUESTA DE LEGALES AGREGAR UN CAMPO QUE NOS DIGA SI EL MEDICAMENTO ES DE POR VIDA O NO

cuadro4 <-  agrup_medicamento %>%
  filter(decil ==10) %>% 
  group_by(DDES_MONODROGA) %>% 
  #group_by(DDES_CORTA_PRACTICA,DDES_MEDICAMENTO, DDES_MONODROGA) %>% 
  #group_by(DDES_MEDICAMENTO, DDES_MONODROGA) %>% 
  summarise(VALOR_ACTUALIZADO = round(sum(NUM_VALOR_ACTUALIZADO_EN_MILL2)/1000000,2),
            CANTIDAD_DE_SOCIOS=sum(CANTIDAD_DE_SOCIOS,na.rm = TRUE),
            MESES_PROMEDIO_CONSUMO = round(sum(meses_promedio),0),
            # NUM_VALOR_ACTUALIZADO_MENSUALIZADO_MILL = ((sum(NUM_VALOR_ACTUALIZADO_EN_MILL2)/sum(meses_promedio))/1000000)/CANTIDAD_DE_SOCIOS,
            #MIN_IMPORTE_FINAL_CON_NOTA_CREDITO=mean(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO)/1000000
            PRECIO_MONODROGA = round(sum(PRECIO_MONODROGA)/1000000,2)) %>% 
  
  #mutate(PROPORCION = round(NUM_VALOR_ACTUALIZADO_EN_MILL/sum(NUM_VALOR_ACTUALIZADO_EN_MILL),4)*100) %>% 
  arrange(desc(CANTIDAD_DE_SOCIOS)) %>% 
  as.data.frame() #%>% 
  #top_n(10)
  #slice_max(order_by = PRECIO_MONODROGA, n = 10)

# # Tabla
# kable(cuadro4, caption = "Top 10 Medicamentos - Valores en Mill. $") %>% 
#   kable_styling() %>%
#   scroll_box(width = "100%") 


cuadro4 %>%
  kable(caption = "Top Medicamentos - Valores en Mill. $") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")





```


<br>

#### Ejemplo DDES_MONODROGA no encontrado (NA)

<br>

En el caso de los socios cuya monodroga no fue identificada en los consumos (NA), se realiza un curado del dato asignándole el campo SUB_PRODUCTO_PRINCIPAL de la base JXNET. A continuación mostramos un ejemplo,


```{r}

ejemplo <- consumos_medicamentos_ic_amparos %>% 
  filter(!DDES_CORTA_PRACTICA %in% c("MEDICAMENTOS AMBULATORIOS","MEDICAMENTOS GTOS DE DISPENSA")) %>% 
  inner_join(amparos_mac_analisis %>% # nos quedamos solo con los mac_analisis 
               select(DNUM_IC,PERIODO_CONSUMO) %>%
               distinct()) %>% 
  left_join(PRECIOS_MINIMOS %>% group_by(DDES_MONODROGA) %>%
              summarise(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO=max(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO))) %>% 
  filter(is.na(DDES_MONODROGA)) %>% 
         #&DNUM_IC=='2002758173') %>% 
  #mutate(PRECIO=NUM_VALOR_ACTUALIZADO/NUM_CANTIDAD) %>% 
  select(DNUM_IC,DNUM_ANOMES_PRESTACION, NUM_VALOR_ACTUALIZADO, NUM_CANTIDAD, DDES_MONODROGA) %>% 
  group_by(DNUM_IC) %>% 
  summarise(MESES_DISTINTOS=n_distinct(DNUM_ANOMES_PRESTACION),
            PRECIO=(sum(NUM_VALOR_ACTUALIZADO)/sum(NUM_CANTIDAD))/1000000) %>% 
  left_join((amparos_mac_analisis %>%
              group_by(DNUM_IC) %>% 
              summarise(FECHA_INICIO=max(FECHA_INICIO))) %>% 
              left_join(amparos_mac_analisis %>% select(DNUM_IC,FECHA_INICIO,SUB_PRODUCTO_PRINCIPAL))) %>% 
  distinct() %>% 
  as.data.frame()

# Tabla
kable(ejemplo[1,c(1:3,5)],
      caption = "Ejemplo DDES_MONODROGA NA - Precio en Mill. $") %>% 
  kable_styling() %>%
  scroll_box(width = "100%") 


```

