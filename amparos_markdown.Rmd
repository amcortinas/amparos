---
title: "Informe Amparos"
author: "CDD"
output: 
  html_document:
     toc: yes
     code_folding: hide
     toc_float: yes
     df_print: paged
     theme: united
     code_download: true
     includes:
       before_body: logo.html
     warning: FALSE
date: "`r format(Sys.time(), '%d-%m-%Y')`"

---


```{css, echo=FALSE}
.tocify .tocify-item.active,
.tocify .tocify-item.tocify-active { 
  background-color: #0046b3 !important;
  color: white !important;
}
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE)
```


```{r, include=FALSE}

# Levantamos las liberias
library(tidyverse)
library(DBI)
library(odbc)
library(knitr)
library(kableExtra)
library(tictoc)
library(dplyr)
library(grid)

# Sacamos la notacion cientifica
options(scipen = 999)

# Set encoding
invisible(Sys.setlocale("LC_CTYPE", "es_ES.UTF-8"))

# Diferentes GIFS 
# https://miro.medium.com/v2/resize:fit:1400/0*Xe3YnRNqb7AuIUdu.gif
# https://antonio-richaud.com/blog/imagenes/archivo/36-kmeans-vs-gmm/kmeans.gif

```


```{r, include=FALSE}

###############################################################################################
# Levantamos la base de legales + consumos + precios monodroga                                #
###############################################################################################

load("Z:/Gcia Presupuesto/DATA MINING/desarrollo/alejandro/laburo/amparos/amparos_consumos.RData")

amparos_mac <- amparos %>%
  filter(PRODUCTO_PRINCIPAL == "Medicamentos de Alta Complejidad- MAC")

load("Z:/Gcia Presupuesto/00_COSTOS/COSTOS/MEDICAMENTOS/PRECIOS_MINIMOS_MAC/PRECIOS_MINIMOS_MAC.RData")

#sum(is.na(amparos_mac$DNUM_IC))

###############################################################################################
# Sacamos los casos que no tenemos IC                                                         #
###############################################################################################

amparos_mac_sin_ic <- amparos_mac %>%
  filter(is.na(DNUM_IC))

amparos_mac_con_ic <- amparos_mac %>%
  filter(!is.na(DNUM_IC))

# ctrl

nrow(amparos_mac)-nrow(amparos_mac_con_ic)-nrow(amparos_mac_sin_ic)


```

```{r include=FALSE}

consumos_medicamentos_ic_amparos$DDES_MOTIVO_BAJA <- trimws(consumos_medicamentos_ic_amparos$DDES_MOTIVO_BAJA)

motivo_baja_fallec <- consumos_medicamentos_ic_amparos %>%
  filter(grepl("allec", DDES_MOTIVO_BAJA, ignore.case = TRUE)) %>% 
  select(DNUM_IC, DDES_MOTIVO_BAJA) %>% distinct()

motivo_baja_fallec$DDES_MOTIVO_BAJA <- "Fallecimiento"

fecha_min_consumo <- min(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION)

# amparos <- amparos %>% 
#   mutate(PERIODO_CONSUMO = case_when(is.na(FECHA_CIERRE)~ "Consumos Abiertos",
#                                       FECHA_CIERRE< fecha_min_consumo ~ "Consumos cerrados fuera del período de Análisis",
#                                      TRUE ~ "Consumos cerrados dentro del período de análisis")) 

amparos <- amparos %>% 
  mutate(PERIODO_CONSUMO = case_when(CARTERA_ACTIVA_SN=="S"~ "Cartera Activa",
                                     TRUE ~ "Cartera No Activa"))  


amparos$DNUM_IC <- as.character(amparos$DNUM_IC)

amparos_mac <- amparos %>% 
  filter(PRODUCTO_PRINCIPAL == "Medicamentos de Alta Complejidad- MAC") %>% 
  left_join(motivo_baja_fallec)

amparos_mac$DDES_MOTIVO_BAJA[is.na(amparos_mac$DDES_MOTIVO_BAJA)] <- "Cartera"


```


<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Objetivo </b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>

El presente trabajo tiene como objetivo analizar el comportamiento de los socios que poseen amparos, focalizándonos en aquellos cuyo producto principal corresponde a **`r unique(amparos_mac$PRODUCTO_PRINCIPAL)`**. En una primera instancia se realizará un análisis descriptivo de esta población, con el propósito de comprender su composición y características principales. Posteriormente, se examinarán los patrones de consumo observados durante el período comprendido entre **`r min(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION)`** y **`r max(consumos_medicamentos_ic_amparos$DNUM_ANOMES_PRESTACION)`**, a fin de identificar los medicamentos de alto consumo.


<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Fuente de datos</b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>



La base de datos utilizada en este análisis fueron del sistema **JXNET** de legales (Amparos) y los consumos actualizados a valores de septiembre 2025 (**SITUACION_ACTUAL_202509**- DATAMART).

<br>

<h1 style="color:#0066B3; text-align:left; margin-top: 20px;font-size: 22px;">

<b> Descriptivo</b>

</h1>

<hr style="border: none; height: 0.9px; background-color: #0072BC; margin-top: 5px; margin-bottom: 20px;">

<br>



Los amparos con producto **`r unique(amparos_mac$PRODUCTO_PRINCIPAL)`** representan el **`r paste0(round(nrow(amparos_mac)/nrow(amparos),4)*100,"%")`** del total.

Comenzamos con un universo de 580 socios MAC. De estos, 58 socios fallecieron, por lo que fueron excluidos del estudio.

De los 522 socios restantes nos enfocamos en los 476 socios que se encuentran en la cartera activa. Los 46 socios con cartera no activa fueron excluidos por no cumplir con los criterios de inclusión del estudio.

<br>

```{r}
motivo_baja <- amparos_mac %>% 
  group_by(DDES_MOTIVO_BAJA) %>% 
  summarise(conteo=n())

consumos <- amparos_mac %>% 
  filter(DDES_MOTIVO_BAJA=="Cartera") %>% 
  group_by(PERIODO_CONSUMO) %>% 
  summarise(conteo=n())


datos <- data.frame(
  #paso = c("Socios MAC", unique(amparos_mac$DDES_MOTIVO_BAJA), unique(amparos_mac$PERIODO_CONSUMO)),
  paso = c("Socios MAC", unique(amparos_mac$DDES_MOTIVO_BAJA),
           "Cartera Activa", "Cartera No Activaa"),
  n = c(nrow(amparos_mac), motivo_baja$conteo, consumos$conteo),
  x = c(1, 0, 2, -0.75, 0.75),
  y = c(2, 1, 1, 0, 0),
  color = c("#0057B8", "#0057B8", "#0057B8", "#E67E22", "#0057B8")
)


# Gráfico con bloques y conexiones
ggplot(datos) +
  # Bloques azules
    geom_rect(aes(xmin = x - 0.5, xmax = x + 0.5, ymin = y - 0.2, ymax = y + 0.2,fill = color),
              color = "black") +
  
  # Texto dentro de los bloques
  geom_text(aes(x = x, y = y,
                label = paste0(paso, "\n(n = ", format(n, big.mark = "."), ")")),
            color = "white", size = 4, lineheight = 1.1) +
  
  # Flechas entre niveles
  geom_segment(aes(x = 1, xend = 0, y = 1.8, yend = 1.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  geom_segment(aes(x = 1, xend = 2, y = 1.8, yend = 1.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  
  # Flechas desde "Activos" hacia los dos subniveles
  geom_segment(aes(x = 0, xend = -0.5, y = 0.8, yend = 0.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  geom_segment(aes(x = 0, xend = 0.5, y = 0.8, yend = 0.2),
               arrow = arrow(length = unit(0.2, "cm")), color = "gray40") +
  
  # Tema general
  scale_fill_identity() +
  theme_void() +
  coord_fixed(ratio = 1)

```

<br>

#### Socios con consumos en el período analizado

```{r}

consumos_medicamentos_ic_amparos$DDES_CORTA_PRACTICA <- trimws(consumos_medicamentos_ic_amparos$DDES_CORTA_PRACTICA)

amparos_mac_analisis <- amparos_mac %>%
                filter(PERIODO_CONSUMO=="Cartera Activa"&DDES_MOTIVO_BAJA!="Fallecimiento")


meses_promedio_consumo_medicamento <- consumos_medicamentos_ic_amparos %>%
  filter(!DDES_CORTA_PRACTICA %in% c("MEDICAMENTOS AMBULATORIOS","MEDICAMENTOS GTOS DE DISPENSA")) %>% 
  inner_join(amparos_mac_analisis %>% # nos quedamos solo con los mac_analisis 
              select(DNUM_IC,PERIODO_CONSUMO) %>%
              distinct()) %>% 
  #group_by(DNUM_IC,DDES_CORTA_PRACTICA, DDES_MEDICAMENTO, DDES_MONODROGA, PERIODO_CONSUMO) %>%
  #group_by(DNUM_IC, DDES_CORTA_PRACTICA) %>% 
  group_by(DNUM_IC,DDES_MONODROGA) %>% #quiero saber cuantos meses consumio cada socio la monodroga
  summarise(conteo_meses_consumo = n_distinct(DNUM_ANOMES_PRESTACION)) %>% 
  #group_by(DDES_CORTA_PRACTICA,DDES_MEDICAMENTO, DDES_MONODROGA, PERIODO_CONSUMO) %>% 
  group_by(DDES_MONODROGA) %>% 
  summarise(meses_promedio=round(mean(conteo_meses_consumo),2))

amparos$DNUM_IC <- as.character(amparos$DNUM_IC)

amparos_mac_analisis <- amparos_mac %>%
                filter(PERIODO_CONSUMO=="Cartera Activa"&DDES_MOTIVO_BAJA!="Fallecimiento")

amparos_mac_analisis$DNUM_IC <- as.character(amparos_mac_analisis$DNUM_IC)

agrup_medicamento <- consumos_medicamentos_ic_amparos %>% 
  filter(!DDES_CORTA_PRACTICA %in% c("MEDICAMENTOS AMBULATORIOS","MEDICAMENTOS GTOS DE DISPENSA")) %>% 
  inner_join(amparos_mac_analisis %>% # nos quedamos solo con los mac_analisis 
              select(DNUM_IC,PERIODO_CONSUMO) %>%
              distinct()) %>% 
  left_join(PRECIOS_MINIMOS %>% group_by(DDES_MONODROGA) %>% summarise(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO=max(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO))) %>% 
  group_by(DDES_MONODROGA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO, na.rm = TRUE)/1000000,
            NUM_VALOR_ACTUALIZADO_EN_MILL2 = sum(NUM_VALOR_ACTUALIZADO, na.rm = TRUE),
            CANTIDAD_DE_SOCIOS=n_distinct(DNUM_IC),
            CANTIDAD_MEDICAMENTOS = sum(NUM_CANTIDAD),
            MIN_IMPORTE_FINAL_CON_NOTA_CREDITO=mean(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO)
            ) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  as.data.frame() %>% 
  left_join(meses_promedio_consumo_medicamento)



agrup_medicamento$decil <- cut(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                breaks = quantile(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                                  probs = seq(0, 1, 0.1), na.rm = TRUE),
                include.lowest = TRUE,
                labels = FALSE)

resumen_df <- agrup_medicamento %>% 
  group_by(decil) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL=sum(NUM_VALOR_ACTUALIZADO_EN_MILL, na.rm = TRUE),
            NUM_VALOR_ACTUALIZADO_EN_MILL2=sum(NUM_VALOR_ACTUALIZADO_EN_MILL2, na.rm = TRUE),
            #promedio = mean(NUM_VALOR_ACTUALIZADO_EN_MILL,na.rm=TRUE),
            cantidad_socios= sum(CANTIDAD_DE_SOCIOS),
            CANTIDAD_MEDICAMENTOS=sum(CANTIDAD_MEDICAMENTOS),
            meses_promedio=mean(meses_promedio)) #%>% 
  #mutate(promedio_por_socio=NUM_VALOR_ACTUALIZADO_EN_MILL/cantidad_socios,
         #promedio_mensual_socio=NUM_VALOR_ACTUALIZADO_EN_MILL2/meses_promedio)



```


El siguiente gráfico nos indica la cantidad de socios que consumieron medicamentos en un decil determinado. (El decil fue calculado según el importe agrupado por monodroga). Podemos obervar que el decil con mayor socios es el 10 y un poco mas atras el 4, 5 y 9.

<br>

```{r}
resumen_df %>% 
  ggplot(aes(x=factor(decil),y=cantidad_socios))+
  geom_col(fill = "#0047AB")+
  geom_text(aes(label = round(cantidad_socios, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Cantidad de socios por Decil",
       x = "Decil",
       y = "Cantidad") +
  theme_minimal()
```

<br>

De la misma forma se gráfico el importe promedio por socio (en millones de $). Se observa que el mayor promedio se encuentra en el decil 10 y mas atras el decil 9. 

<br>

```{r}

# resumen_df2 <- agrup_medicamento %>% 
#   mutate(consumo_promedio_mensual_por_socio = (NUM_VALOR_ACTUALIZADO_EN_MILL2/meses_promedio)/1000000)

resumen_df %>% 
  ggplot(aes(x=factor(decil),y=NUM_VALOR_ACTUALIZADO_EN_MILL))+
  geom_col(fill = "#1E90FF")+
  #geom_col()+
  geom_text(aes(label = round(NUM_VALOR_ACTUALIZADO_EN_MILL, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Promedio por decil en Millones de $",
       x = "Decil",
       y = "Promedio") +
  theme_minimal()



```

<br>

#### ¿Cuales son esos medicamentos?



```{r}

cuadro4 <-  agrup_medicamento %>%
  filter(decil ==10) %>% 
  group_by(DDES_MONODROGA) %>% 
  #group_by(DDES_CORTA_PRACTICA,DDES_MEDICAMENTO, DDES_MONODROGA) %>% 
  #group_by(DDES_MEDICAMENTO, DDES_MONODROGA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO_EN_MILL2)/1000000,
            CANTIDAD_DE_SOCIOS=sum(CANTIDAD_DE_SOCIOS,na.rm = TRUE),
            MESES_PROMEDIO_CONSUMO = sum(meses_promedio),
            NUM_VALOR_ACTUALIZADO_MENSUALIZADO_MILL = ((sum(NUM_VALOR_ACTUALIZADO_EN_MILL2)/sum(meses_promedio))/1000000)/CANTIDAD_DE_SOCIOS,
            MIN_IMPORTE_FINAL_CON_NOTA_CREDITO=mean(MIN_IMPORTE_FINAL_CON_NOTA_CREDITO)/1000000) %>% 
  
  #mutate(PROPORCION = round(NUM_VALOR_ACTUALIZADO_EN_MILL/sum(NUM_VALOR_ACTUALIZADO_EN_MILL),4)*100) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  as.data.frame() %>% 
  #top_n(10)
  slice_max(order_by = NUM_VALOR_ACTUALIZADO_EN_MILL, n = 10)

# Tabla
kable(cuadro4, caption = "Top 10 Medicamentos") %>% 
  kable_styling() %>%
  scroll_box(width = "100%") 




```




```{r, eval=FALSE}

sum(agrup_medicamento$CANTIDAD_DE_SOCIOS[agrup_medicamento$decil>=9],na.rm = TRUE)

```



```{r, eval=FALSE}
###############################################################################################
# Graficamos el decil 9 y 10                                                                  #
###############################################################################################


agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_boxplot()+
  theme_bw()

agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```

```{r, eval=FALSE}

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC,DID_NOMENCLADOR,DDES_CORTA_PRACTICA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```







```{r,eval=FALSE}
agrup_socio <- consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000,
            CANTIDAD_DE_SOCIOS=n_distinct(DNUM_IC)) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL))



agrup_medicamento$decil <- cut(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                breaks = quantile(agrup_medicamento$NUM_VALOR_ACTUALIZADO_EN_MILL,
                                  probs = seq(0, 1, 0.1), na.rm = TRUE),
                include.lowest = TRUE,
                labels = FALSE)

#Agrupar por decil y calcular cantidad y promedio
resumen <- aggregate(NUM_VALOR_ACTUALIZADO_EN_MILL ~ decil, data = agrup_medicamento, 
                     FUN = function(x) c(cantidad = length(x), promedio = mean(x)))

# Convertir a data.frame
resumen_df <- data.frame(
  decil = resumen$decil,
  cantidad = resumen$NUM_VALOR_ACTUALIZADO_EN_MILL[, "cantidad"],
  promedio = resumen$NUM_VALOR_ACTUALIZADO_EN_MILL[, "promedio"]
)


```

```{r, eval=FALSE}
resumen_df %>% 
  ggplot(aes(x=factor(decil),y=cantidad))+
  geom_col()+
  geom_text(aes(label = round(cantidad, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Cantidad de Medicamentos por Decil",
       x = "Decil",
       y = "Cantidad") +
  theme_minimal()

resumen_df %>% 
  ggplot(aes(x=factor(decil),y=promedio))+
  geom_col()+
  geom_text(aes(label = round(promedio, 1)), 
            vjust = -0.5, size = 4) +
  labs(title = "Promedio por decil en Millones de $",
       x = "Decil",
       y = "Promedio") +
  theme_minimal()



```



```{r,eval=FALSE}
###############################################################################################
# Graficamos el decil 9 y 10                                                                  #
###############################################################################################


agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_boxplot()+
  theme_bw()

agrup_medicamento %>% 
  filter(decil>=9) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```

```{r,eval=FALSE}

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

consumos_medicamentos_ic_amparos %>% 
  group_by(DNUM_IC,DID_NOMENCLADOR,DDES_CORTA_PRACTICA) %>% 
  summarise(NUM_VALOR_ACTUALIZADO_EN_MILL = sum(NUM_VALOR_ACTUALIZADO)/1000000) %>% 
  arrange(desc(NUM_VALOR_ACTUALIZADO_EN_MILL)) %>% 
  ggplot(aes(NUM_VALOR_ACTUALIZADO_EN_MILL)) +
  geom_histogram()+
  theme_bw()

```

